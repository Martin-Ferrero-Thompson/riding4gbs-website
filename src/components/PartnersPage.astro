---
import MainLayout from "../layouts/MainLayout.astro";
import { LogoCarousel } from "./LogoCarousel.jsx";
import partners from "../data/partners.json";
import type {
  PartnersLocaleContent,
  PartnersSectionKey,
} from "../data/partners.i18n";
import { marked } from "marked";

export interface Props {
  lang: "en" | "es" | "eu";
  t: PartnersLocaleContent;
  tEu?: PartnersLocaleContent;
}

const { t, tEu } = Astro.props as Props;

function hasList(key: PartnersSectionKey): boolean {
  const list = (partners as any)[key];
  return Array.isArray(list) && list.length > 0;
}
---

<MainLayout title={t.metaTitle}>
  <div
    transition:name="partners-card"
    class="page-card-dark max-w-6xl w-full mx-auto font-body"
  >
    <div class="text-center">
      <h1 class="hero-title text-white" data-lang={Astro.props.lang}>
        {t.heroTitle}
      </h1>
      {
        tEu && (
          <h1 class="hero-title text-white hidden" data-lang="eu">
            {tEu.heroTitle}
          </h1>
        )
      }
      <div
        class="mt-4 max-w-3xl mx-auto text-center font-body text-base md:text-lg lg:text-xl text-gray-300"
        data-lang={Astro.props.lang}
        set:html={marked.parse(t.heroSubtitleMd)}
      />
      {
        tEu && (
          <div
            class="mt-4 max-w-3xl mx-auto text-center font-body text-base md:text-lg lg:text-xl text-gray-300 hidden"
            data-lang="eu"
            set:html={marked.parse(tEu.heroSubtitleMd)}
          />
        )
      }
    </div>

    <div class="mt-10 md:mt-16 space-y-10 md:space-y-12">
      {
        t.sections.map(
          (section, index) =>
            hasList(section.key) && (
              <div>
                <h2
                  class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-center text-gray-300 tracking-wider uppercase"
                  data-lang={Astro.props.lang}
                >
                  {section.heading}
                </h2>
                {tEu && tEu.sections[index] && (
                  <h2
                    class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-center text-gray-300 tracking-wider uppercase hidden"
                    data-lang="eu"
                  >
                    {tEu.sections[index].heading}
                  </h2>
                )}
                <div class="mt-8">
                  <LogoCarousel
                    client:visible
                    partners={(partners as any)[section.key]}
                  />
                </div>
              </div>
            ),
        )
      }
    </div>

    {
      (t.showDividerBeforeCta ?? false) && (
        <hr class="my-12 md:my-16 border-white/20 w-48 mx-auto" />
      )
    }

    <div class="mt-12 md:mt-16 bg-gray-100 rounded-xl p-8 md:p-12 text-center">
      <h2
        class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-gray-900"
        data-lang={Astro.props.lang}
      >
        {t.cta.heading}
      </h2>
      {
        tEu && (
          <h2
            class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-gray-900 hidden"
            data-lang="eu"
          >
            {tEu.cta.heading}
          </h2>
        )
      }

      <div
        class="mt-4 max-w-2xl mx-auto font-body text-base md:text-lg lg:text-xl text-gray-600 leading-relaxed [&>*:not(:first-child)]:mt-3 [&_p]:text-gray-600"
        data-lang={Astro.props.lang}
        set:html={marked.parse(t.cta.bodyMd)}
      />
      {
        tEu && (
          <div
            class="mt-4 max-w-2xl mx-auto font-body text-base md:text-lg lg:text-xl text-gray-600 leading-relaxed [&>*:not(:first-child)]:mt-3 [&_p]:text-gray-600 hidden"
            data-lang="eu"
            set:html={marked.parse(tEu.cta.bodyMd)}
          />
        )
      }

      <div class="mt-8">
        <a
          id="sponsor-download"
          href={t.cta.buttonHref}
          class="inline-block px-10 py-4 bg-brand-blue hover:bg-blue-700 text-white font-bold text-lg rounded-full transition-transform transform hover:scale-105"
          data-lang={Astro.props.lang}
        >
          {t.cta.buttonLabel}
        </a>
        {
          tEu && (
            <a
              href={tEu.cta.buttonHref}
              class="inline-block px-10 py-4 bg-brand-blue hover:bg-blue-700 text-white font-bold text-lg rounded-full transition-transform transform hover:scale-105 hidden"
              data-lang="eu"
            >
              {tEu.cta.buttonLabel}
            </a>
          )
        }
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { readStoredLanguage } from "../utils/language";

  async function updateLanguage() {
    const lang = await readStoredLanguage();
    const baseLang = document
      .querySelector('h1.hero-title[data-lang]:not([data-lang="eu"])')
      ?.getAttribute("data-lang");

    if (baseLang) {
      const elements = document.querySelectorAll("[data-lang]");
      elements.forEach((el) => {
        const elLang = el.getAttribute("data-lang");
        if (lang === "eu") {
          if (elLang === "eu") el.classList.remove("hidden");
          if (elLang === baseLang) el.classList.add("hidden");
        } else {
          if (elLang === "eu") el.classList.add("hidden");
          if (elLang === baseLang) el.classList.remove("hidden");
        }
      });
    }
  }

  updateLanguage();
  document.addEventListener("language-change", updateLanguage);
</script>
