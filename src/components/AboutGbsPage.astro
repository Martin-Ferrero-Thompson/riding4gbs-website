---
import MainLayout from "../layouts/MainLayout.astro";
import { Carousel } from "./Carousel.jsx";
import i18n from "../data/sidebar.json";
import type { AboutGbsLocaleContent, AboutGbsSlide } from "../data/aboutGbs.i18n";
import { marked } from "marked";

export interface Props {
  lang: "en" | "es" | "fr";
  t: AboutGbsLocaleContent;
  tEu?: AboutGbsLocaleContent;
}

const { lang, t, tEu } = Astro.props as Props;
const sidebar = i18n[lang];

function renderSlideToHtml(slide: AboutGbsSlide): string {
  if (slide.kind === "narrative") {
    return `<div class="space-y-4 text-lg text-gray-600 leading-relaxed [&_ol]:list-decimal [&_ol]:list-inside [&_ul]:list-disc [&_ul]:list-inside [&_li]:mt-2 [&_li>p]:inline [&_li>p]:ml-2">${marked.parse(slide.bodyMd)}</div>`;
  }
  if (slide.kind === "image") {
    const caption = slide.captionMd ? `<p class=\"mt-4 text-center text-sm text-gray-500\">${marked.parse(slide.captionMd)}</p>` : "";
    return `\n      <img src=\"${slide.image.src}\" alt=\"${slide.image.alt}\" class=\"rounded-xl shadow-lg w-full object-cover\" />\n      ${caption}\n    `;
  }
  // resources
  const isSingleResource = slide.resources.length === 1;
  const cards = slide.resources
    .map(
      (r) => `
        <div class="bg-white rounded-lg shadow-sm p-6 flex flex-col text-center w-full ${isSingleResource ? "max-w-4xl mx-auto" : ""}">
          <h4 class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-gray-900">${r.title}</h4>
          <p class="text-gray-600 mt-2 flex-grow text-sm">${marked.parse(r.descriptionMd)}</p>
          <a href="${r.href}" target="_blank" rel="noopener noreferrer" class="mt-4 inline-block text-brand-blue font-semibold hover:underline">${r.ctaLabel}</a>
        </div>
      `
    )
    .join("");
  const gridClasses = isSingleResource ? "grid grid-cols-1 gap-8" : "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8";
  return `<div class="${gridClasses}">${cards}</div>`;
}

const slides = t.slides.map((s) => ({ title: s.title, content: renderSlideToHtml(s) }));
const slidesEu = tEu ? tEu.slides.map((s) => ({ title: s.title, content: renderSlideToHtml(s) })) : [];
const slidesMap = tEu ? { es: slides, eu: slidesEu } : undefined;
---

<MainLayout title={t.metaTitle}>
  <div
    class="page-card-dark max-w-6xl w-full mx-auto font-body"
  >
    <div class="text-center">
      <h1 class="hero-title text-white" data-lang={lang}>
        {t.heroTitle}
      </h1>
      {tEu && (
        <h1 class="hero-title text-white hidden" data-lang="eu">
          {tEu.heroTitle}
        </h1>
      )}
      <p class="mt-4 max-w-2xl mx-auto font-body text-base md:text-lg lg:text-xl text-gray-300" data-lang={lang}>
        {t.heroSubtitle}
      </p>
      {tEu && (
        <p class="mt-4 max-w-2xl mx-auto font-body text-base md:text-lg lg:text-xl text-gray-300 hidden" data-lang="eu">
          {tEu.heroSubtitle}
        </p>
      )}
    </div>

    <div class="mt-8">
      <Carousel client:load slides={slides} slidesMap={slidesMap} i18n={sidebar} />
    </div>
  </div>
  {tEu && (
    <script>
      import { readStoredLanguage } from "../utils/language";

      async function updateLanguage() {
        const lang = await readStoredLanguage();
        const baseLang = document.querySelector('h1.hero-title[data-lang]:not([data-lang="eu"])')?.getAttribute('data-lang');
        
        if (baseLang) {
            const elements = document.querySelectorAll('[data-lang]');
            elements.forEach(el => {
                const elLang = el.getAttribute('data-lang');
                if (lang === 'eu') {
                    if (elLang === 'eu') el.classList.remove('hidden');
                    if (elLang === baseLang) el.classList.add('hidden');
                } else {
                    if (elLang === 'eu') el.classList.add('hidden');
                    if (elLang === baseLang) el.classList.remove('hidden');
                }
            });
        }
      }

      updateLanguage();
      document.addEventListener('language-change', updateLanguage);
    </script>
  )}
</MainLayout>
