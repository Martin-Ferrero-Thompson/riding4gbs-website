---
import LanguageSwitcherIsland from "./LanguageSwitcherIsland.tsx";
import {
  DEFAULT_LANGUAGE,
  SUPPORTED_LANGUAGES,
  type Language,
} from "../utils/language";

/**
 * LanguageSwitcher.astro
 *
 * Semantic language switcher with an optional interactive Solid island.
 * Falls back to static links when `interactive={false}`.
 */
interface Props {
  class?: string;
  ariaLabel?: string;
  labels?: Partial<Record<Language, string>>;
  flags?: Partial<Record<Language, string>>;
  showFlags?: boolean;
  interactive?: boolean;
}

const {
  class: className = "",
  ariaLabel = "Language",
  labels: customLabels = {},
  flags: customFlags = {},
  showFlags = true,
  interactive = false,
} = Astro.props as Props;

const baseBtnClasses =
  "px-2.5 py-1 text-sm font-medium rounded-md border flex items-center gap-1 border-gray-600 text-gray-200 hover:text-white hover:border-gray-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-yellow-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-800 transition";

const defaultLabels: Record<Language, string> = {
  en: "EN",
  es: "ES",
  eu: "EU",
  fr: "FR",
};

const defaultFlags: Record<Language, string> = {
  en: "ðŸ‡¬ðŸ‡§",
  es: "ðŸ‡ªðŸ‡¸",
  eu: "/flags/eu.svg",
  fr: "ðŸ‡«ðŸ‡·",
};

const labels: Record<Language, string> = {
  en: customLabels.en ?? defaultLabels.en,
  es: customLabels.es ?? defaultLabels.es,
  eu: customLabels.eu ?? defaultLabels.eu,
  fr: customLabels.fr ?? defaultLabels.fr,
};

const flags: Record<Language, string> = {
  en: customFlags.en ?? defaultFlags.en,
  es: customFlags.es ?? defaultFlags.es,
  eu: customFlags.eu ?? defaultFlags.eu,
  fr: customFlags.fr ?? defaultFlags.fr,
};

const isFlagImage = (value: string) => /^(?:\/?[\w\-\.]+\/.+|https?:\/\/|data:\w+\/\w+)/.test(value);

const path = Astro.url.pathname;
const firstSeg = path.split("/").filter(Boolean)[0] ?? "";
const currentLang: Language = (SUPPORTED_LANGUAGES as readonly string[]).includes(firstSeg)
  ? (firstSeg as Language)
  : DEFAULT_LANGUAGE;

function targetUrl(target: Language): string {
  const parts = path.split("/");
  const hasLangPrefix = (SUPPORTED_LANGUAGES as readonly string[]).includes(parts[1] ?? "");

  if (!hasLangPrefix) {
    return `/${target}/`;
  }

  parts[1] = target;
  let url = parts.join("/").replace(/\/+/g, "/");

  if (!url.endsWith("/") && !/\.[a-z0-9]+$/i.test(url)) {
    url += "/";
  }

  return url;
}

const interactiveOptions = SUPPORTED_LANGUAGES.map((lang) => ({
  code: lang,
  label: labels[lang],
  flag: flags[lang],
}));

const staticOptions = SUPPORTED_LANGUAGES.map((lang) => ({
  code: lang,
  label: labels[lang],
  flag: flags[lang],
  href: targetUrl(lang),
  isCurrent: lang === currentLang,
}));
---

{interactive ? (
  <LanguageSwitcherIsland
    client:load
    ariaLabel={ariaLabel}
    className={className}
    options={interactiveOptions}
    initialLang={currentLang}
    showFlags={showFlags}
    baseBtnClasses={baseBtnClasses}
  />
) : (
  <nav aria-label={ariaLabel} class:list={["inline-block", className]}>
    <ul class="flex items-center gap-2">
      {staticOptions.map(({ code, label, flag, href, isCurrent }) => (
        <li>
          {isCurrent ? (
            <span
              aria-current="true"
              class="px-2.5 py-1 text-sm font-medium rounded-md border border-gray-600 bg-gray-700 text-white cursor-default select-none flex items-center gap-1"
            >
              {showFlags && (isFlagImage(flag) ? (
                <img
                  src={flag}
                  alt=""
                  aria-hidden="true"
                  width={16}
                  height={12}
                  class="inline-block w-4 h-3 object-cover"
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <span aria-hidden="true">{flag}</span>
              ))}
              {label}
            </span>
          ) : (
            <a
              href={href}
              lang={code}
              hreflang={code}
              class="px-2.5 py-1 text-sm font-medium rounded-md border border-gray-600 text-gray-200 hover:text-white hover:border-gray-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-yellow-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-800 transition flex items-center gap-1"
            >
              {showFlags && (isFlagImage(flag) ? (
                <img
                  src={flag}
                  alt=""
                  aria-hidden="true"
                  width={16}
                  height={12}
                  class="inline-block w-4 h-3 object-cover"
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <span aria-hidden="true">{flag}</span>
              ))}
              {label}
            </a>
          )}
        </li>
      ))}
    </ul>
  </nav>
)}
