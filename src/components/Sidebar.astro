---
import progressData from "../data/progress.json";
import i18n from "../data/sidebar.json";
import { Countdown } from "./Countdown.jsx";

const currentPath = Astro.url.pathname;
const lang = currentPath.startsWith("/es") ? "es" : currentPath.startsWith("/fr") ? "fr" : "en";
const t = i18n[lang];

// Normalize paths to ensure exact-match comparison works regardless of trailing slashes
const normalizePath = (p: string) => {
  if (!p) return "/";
  try {
    const u = new URL(p, "http://local");
    p = u.pathname;
  } catch {
    // p is likely already a pathname like "/en/my-story"
  }
  // Remove trailing slash except for root
  if (p.length > 1 && p.endsWith("/")) p = p.slice(0, -1);
  return p;
};

const currentPathNormalized = normalizePath(currentPath);
const isActive = (href: string) => normalizePath(href) === currentPathNormalized;

const gbpFormatter = new Intl.NumberFormat("en-GB", {
  style: "currency",
  currency: "GBP",
  minimumFractionDigits: 0,
});
const eurFormatter = new Intl.NumberFormat("de-DE", {
  style: "currency",
  currency: "EUR",
  minimumFractionDigits: 0,
});
---

<aside
  id="sidebar"
  class="bg-gray-900 bg-opacity-90 text-white p-6 flex flex-col min-h-screen w-72 hidden md:flex absolute md:relative z-40"
>
  <div class="logo mb-8">
    <a href={`/${lang}/`} class="text-3xl font-bold text-brand-blue font-display"
      >Riding4GBS</a
    >
    <p class="text-sm text-gray-400 font-sans">#RIDING4GBS</p>
  </div>

  <!-- <div class="bg-gray-800 rounded-lg p-4 text-center font-sans mb-8">
    <Countdown client:visible i18n={t} targetDate={progressData.targetDate} />
  </div> -->

  <div class="bg-gray-800 rounded-lg p-4 text-center font-sans mb-8">
    <p class="text-sm font-bold text-gray-300 mb-2">{t.totalRaised}</p>
    <div class="space-y-2">
      <div>
        <span class="text-2xl font-bold text-blue-400">
          {gbpFormatter.format(progressData.funds_gbp.current)}
        </span>
        <span class="text-xs text-gray-400"> ({t.countries.uk})</span>
      </div>
      <div>
        <span class="text-2xl font-bold text-blue-400">
          {eurFormatter.format(progressData.funds_eur.current)}
        </span>
        <span class="text-xs text-gray-400"> ({t.countries.es})</span>
      </div>
      {progressData.funds_eur_fr && (
        <div>
          <span class="text-2xl font-bold text-blue-400">
            {eurFormatter.format(progressData.funds_eur_fr.current)}
          </span>
          <span class="text-xs text-gray-400"> ({t.countries.fr})</span>
        </div>
      )}
    </div>
  </div>

  <div class="mb-8 font-sans">
    <a
      href={`/${lang}/donate`}
      class="block w-full text-center bg-brand-teal hover:bg-teal-600 p-3 rounded-lg font-bold transition-colors"
    >
      {t.donateNow}
    </a>
  </div>

  <nav class="flex flex-col space-y-6 font-sans text-lg">
    <a
      href={`/${lang}/the-challenge`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/the-challenge`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/the-challenge`),
      }}
      aria-current={isActive(`/${lang}/the-challenge`) ? "page" : undefined}
      >{t.challenge}</a
    >
    <a
      href={`/${lang}/my-story`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/my-story`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/my-story`),
      }}
      aria-current={isActive(`/${lang}/my-story`) ? "page" : undefined}
      >{t.myStory}</a
    >
    <a
      href={`/${lang}/about-gbs`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/about-gbs`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/about-gbs`),
      }}
      aria-current={isActive(`/${lang}/about-gbs`) ? "page" : undefined}
      >{t.aboutGBS}</a
    >
    <a
      href={`/${lang}/our-progress`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/our-progress`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/our-progress`),
      }}
      aria-current={isActive(`/${lang}/our-progress`) ? "page" : undefined}
      >{t.ourProgress}</a
    >
    <a
      href={`/${lang}/journal-hub`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/journal-hub`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/journal-hub`),
      }}
      aria-current={isActive(`/${lang}/journal-hub`) ? "page" : undefined}
      >{t.journalHub}</a
    >
    <a
      href={`/${lang}/partners`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/partners`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/partners`),
      }}
      aria-current={isActive(`/${lang}/partners`) ? "page" : undefined}
      >{t.partners}</a
    >
    <a
      href={`/${lang}/support-me`}
      class:list={{
        "px-3 py-2 rounded-md transition-colors": true,
        "bg-brand-blue text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/80": isActive(`/${lang}/support-me`),
        "hover:bg-brand-blue/20": !isActive(`/${lang}/support-me`),
      }}
      aria-current={isActive(`/${lang}/support-me`) ? "page" : undefined}
      >{t.supportMe}</a
    >
  </nav>

  <div class="mt-12 bg-gray-800 rounded-lg p-4">
    <h3
      class="font-display text-sm font-bold text-gray-400 uppercase tracking-wider text-center mb-4"
    >
      {t.followJourney}
    </h3>
    <div class="space-y-4">
      <div class="flex justify-center items-center gap-x-6">
        <span aria-disabled="true" aria-label="YouTube (coming soon)" title="YouTube link coming soon" class="text-gray-400 opacity-50 pointer-events-none cursor-not-allowed">
          <svg aria-hidden="true" class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0C.887 3.433 0 4.888 0 8.05v7.9c0 3.163.887 4.617 4.385 4.866 3.6.245 11.626.246 15.23 0 3.498-.249 4.385-1.703 4.385-4.866v-7.9c0-3.162-.887-4.617-4.385-4.866Zm-10.615 12.7V5.117l6.963 3.933-6.963 3.933Z"/></svg>
        </span>
        <span aria-disabled="true" aria-label="Facebook (coming soon)" title="Facebook link coming soon" class="text-gray-400 opacity-50 pointer-events-none cursor-not-allowed">
          <svg aria-hidden="true" class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3v9h4v-9Z"/></svg>
        </span>
      </div>
      <div class="flex justify-center items-center gap-x-6">
        <span aria-disabled="true" aria-label="Strava (coming soon)" title="Strava link coming soon" class="text-gray-400 opacity-50 pointer-events-none cursor-not-allowed">
          <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h3.065L8.38 2.173 3.23 12.345h3.065z"/></svg>
        </span>
        <span aria-disabled="true" aria-label="Instagram (coming soon)" title="Instagram link coming soon" class="text-gray-400 opacity-50 pointer-events-none cursor-not-allowed">
          <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2c-2.717 0-3.056.01-4.122.06-1.065.05-1.79.217-2.428.465a4.898 4.898 0 0 0-1.772 1.153 4.9 4.9 0 0 0-1.153 1.772c-.247.637-.39 1.363-.445 2.428C2.01 8.944 2 9.283 2 12s.01 3.056.06 4.122c.05 1.066.217 1.79.465 2.428a4.898 4.898 0 0 0 1.153 1.772 4.9 4.9 0 0 0 1.772 1.153c.637.247 1.363.39 2.428.445C8.944 21.99 9.283 22 12 22s3.056-.01 4.122-.06c1.066-.05 1.79-.217 2.428-.465a4.898 4.898 0 0 0 1.772-1.153 4.9 4.9 0 0 0 1.153-1.772c.247-.637.39-1.363.445-2.428C21.99 15.056 22 14.717 22 12s-.01-3.056-.06-4.122c-.05-1.065-.218-1.79-.465-2.428a4.898 4.898 0 0 0-1.153-1.772 4.9 4.9 0 0 0-1.772-1.153c-.637-.247-1.363-.39-2.428-.445C15.056 2.01 14.717 2 12 2Zm0 1.622c2.684 0 3.023.01 4.088.06 1.054.05 1.63.205 2.08.385.486.19.86.444 1.24.823.38.38.634.755.823 1.24.18.45.335 1.026.385 2.08C20.367 8.977 20.377 9.316 20.377 12s-.01 3.023-.06 4.088c-.05 1.054-.205 1.63-.385 2.08-.19.486-.444.86-.823 1.24-.38.38-.755.634-1.24.823-.45.18-1.026.335-2.08.385-1.065.05-1.404.06-4.088.06s-3.023-.01-4.088-.06c-1.054-.05-1.63-.205-2.08-.385-.486-.19-.86-.444-1.24-.823-.38-.38-.634-.755-.823-1.24-.18-.45-.335-1.026-.385-2.08C3.633 15.023 3.623 14.684 3.623 12s.01-3.023.06-4.088c.05-1.054.205-1.63.385-2.08.19-.486.444-.86.823-1.24.38-.38.755-.634 1.24-.823.45-.18 1.026.335 2.08-.385C8.977 3.633 9.316 3.622 12 3.622ZM12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm0 1.622a3.378 3.378 0 1 1 0 6.756 3.378 3.378 0 0 1 0-6.756ZM16.338 7.3a1.144 1.144 0 1 0 0-2.288 1.144 1.144 0 0 0 0 2.288Z" clip-rule="evenodd"/></svg>
        </span>
        <span aria-disabled="true" aria-label="LinkedIn (coming soon)" title="LinkedIn link coming soon" class="text-gray-400 opacity-50 pointer-events-none cursor-not-allowed">
          <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
        </span>
      </div>
    </div>
  </div>
  <footer class="mt-auto pt-8 text-sm text-gray-400 font-sans">
    <!-- <div class="flex items-center space-x-2 border-b border-gray-700 pb-4 mb-4">
      <span>{t.language}:</span>
      <a href="/en" class="hover:text-white underline">English</a>
      <span>|</span>
      <a href="/es" class="hover:text-white underline">Español</a>
      <span>|</span>
      <a href="/fr" class="hover:text-white underline">Français</a>
    </div> -->
    <p>&copy; 2025 Riding4GBS. {t.rightsReserved}</p>
  </footer>
</aside>