---
import MainLayout from "../layouts/MainLayout.astro";
import type { DonateLocaleContent } from "../data/donate.i18n";
import { marked } from "marked";
import progressEn from "../data/progress.json";
import progressEs from "../data/progress-es.json";
import progressEu from "../data/progress-eu.json";

export interface Props {
  lang: "en" | "es" | "eu";
  t: DonateLocaleContent; // now includes a single `card`
  tEu?: DonateLocaleContent;
}

const { lang, t, tEu } = Astro.props as Props;

const progressByLang: Record<"en" | "es" | "eu", any> = {
  en: progressEn,
  es: progressEs,
  eu: progressEs, // Use ES progress for EU
};

const currencyFormatter: Record<"uk" | "es" | "eu", Intl.NumberFormat> = {
  uk: new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }),
  es: new Intl.NumberFormat("de-DE", {
    style: "currency",
    currency: "EUR",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }),
  eu: new Intl.NumberFormat("de-DE", {
    style: "currency",
    currency: "EUR",
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }),
};

const getFundData = (content: DonateLocaleContent) => {
  let pData = progressByLang[lang];
  if (content.card.id === "uk") pData = progressEn;
  if (content.card.id === "es") pData = progressEs;
  if (content.card.id === "eu") pData = progressEs;

  if (!pData) return undefined;

  if (content.card.id === "uk") return pData.funds_gbp;
  if (content.card.id === "es") return pData.funds_eur;
  if (content.card.id === "eu") return pData.funds_eur;
  return undefined;
};

const fundData = getFundData(t);
const fundDataEu = tEu ? getFundData(tEu) : undefined;

const urls: Record<"uk" | "es" | "eu", string | undefined> = {
  uk: import.meta.env.PUBLIC_DONATE_UK_URL as string | undefined,
  es: import.meta.env.PUBLIC_DONATE_ES_URL as string | undefined,
  eu: import.meta.env.PUBLIC_DONATE_ES_URL as string | undefined, // Use ES URL for EU
};
---

<MainLayout title={t.metaTitle}>
  <div
    transition:name="donate-card"
    class="page-card-dark max-w-6xl w-full mx-auto font-body"
  >
    <div class="text-center">
      <h1 class="hero-title text-white" data-lang={lang}>
        {t.heroTitle}
      </h1>
      {
        tEu && (
          <h1 class="hero-title text-white hidden" data-lang="eu">
            {tEu.heroTitle}
          </h1>
        )
      }
      <div
        class="mt-4 max-w-3xl mx-auto font-body text-base md:text-lg lg:text-xl text-white leading-relaxed [&>*:not(:first-child)]:mt-6 [&_p]:text-white [&_p]:text-left [&_ul]:text-left [&_ul]:list-disc [&_ul]:pl-6 [&_li]:ml-1"
        data-lang={lang}
        set:html={marked.parse(t.heroIntroMd)}
      />
      {
        tEu && (
          <div
            class="mt-4 max-w-3xl mx-auto font-body text-base md:text-lg lg:text-xl text-white leading-relaxed [&>*:not(:first-child)]:mt-6 [&_p]:text-white [&_p]:text-left [&_ul]:text-left [&_ul]:list-disc [&_ul]:pl-6 [&_li]:ml-1 hidden"
            data-lang="eu"
            set:html={marked.parse(tEu.heroIntroMd)}
          />
        )
      }
    </div>

    <div class="mt-12 max-w-3xl mx-auto">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center flex flex-col">
        <h2
          class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-gray-900"
          data-lang={lang}
        >
          {t.card.title}
        </h2>
        {
          tEu && (
            <h2
              class="font-headline font-semibold text-lg md:text-xl lg:text-2xl text-gray-900 hidden"
              data-lang="eu"
            >
              {tEu.card.title}
            </h2>
          )
        }

        <div class="my-4 flex-grow flex justify-center items-center">
          <img src={t.card.image.src} alt={t.card.image.alt} class="h-12" />
        </div>

        {
          fundData && (
            <div
              class="mb-4 text-left bg-gray-50 border border-gray-100 rounded-lg p-4"
              data-lang={lang}
            >
              <p class="text-sm font-semibold uppercase tracking-wide text-gray-500">
                {fundData.label}
              </p>
              <div class="mt-1 flex flex-wrap items-baseline gap-x-3 gap-y-1 text-brand-blue">
                <p class="text-2xl font-bold">
                  {currencyFormatter[t.card.id].format(fundData.current)}
                </p>
                {typeof fundData.total === "number" && (
                  <p class="text-2xl font-bold">
                    {fundData.targetLabel ?? "Target"}:{" "}
                    {currencyFormatter[t.card.id].format(fundData.total)}
                  </p>
                )}
              </div>
            </div>
          )
        }
        {
          tEu && fundDataEu && (
            <div
              class="mb-4 text-left bg-gray-50 border border-gray-100 rounded-lg p-4 hidden"
              data-lang="eu"
            >
              <p class="text-sm font-semibold uppercase tracking-wide text-gray-500">
                {fundDataEu.label}
              </p>
              <div class="mt-1 flex flex-wrap items-baseline gap-x-3 gap-y-1 text-brand-blue">
                <p class="text-2xl font-bold">
                  {currencyFormatter[tEu.card.id].format(fundDataEu.current)}
                </p>
                {typeof fundDataEu.total === "number" && (
                  <p class="text-2xl font-bold">
                    {fundDataEu.targetLabel ?? "Target"}:{" "}
                    {currencyFormatter[tEu.card.id].format(fundDataEu.total)}
                  </p>
                )}
              </div>
            </div>
          )
        }

        <div
          class="text-left text-gray-600 leading-relaxed flex-grow [&_p]:text-gray-600 [&_p]:text-left [&_ul]:list-disc [&_ul]:pl-5 [&_li]:ml-1"
          data-lang={lang}
          set:html={marked.parse(t.card.bodyMd)}
        />
        {
          tEu && (
            <div
              class="text-left text-gray-600 leading-relaxed flex-grow [&_p]:text-gray-600 [&_p]:text-left [&_ul]:list-disc [&_ul]:pl-5 [&_li]:ml-1 hidden"
              data-lang="eu"
              set:html={marked.parse(tEu.card.bodyMd)}
            />
          )
        }

        {
          urls[t.card.id] ? (
            <a
              href={urls[t.card.id]!}
              target="_blank"
              rel="noopener noreferrer"
              class="mt-6 inline-block w-full px-8 py-3 text-white bg-brand-teal hover:bg-teal-600 font-bold text-lg rounded-full transition-transform transform hover:scale-105"
              data-lang={lang}
            >
              {t.card.buttonLabel}
            </a>
          ) : (
            <p
              class="mt-6 text-lg font-bold text-gray-600 italic"
              data-lang={lang}
            >
              {t.comingSoon}
            </p>
          )
        }
        {
          tEu &&
            (urls[tEu.card.id] ? (
              <a
                href={urls[tEu.card.id]!}
                target="_blank"
                rel="noopener noreferrer"
                class="mt-6 inline-block w-full px-8 py-3 text-white bg-brand-teal hover:bg-teal-600 font-bold text-lg rounded-full transition-transform transform hover:scale-105 hidden"
                data-lang="eu"
              >
                {tEu.card.buttonLabel}
              </a>
            ) : (
              <p
                class="mt-6 text-lg font-bold text-gray-600 italic hidden"
                data-lang="eu"
              >
                {tEu.comingSoon}
              </p>
            ))
        }
      </div>
    </div>
  </div>
</MainLayout>

<script>
  import { readStoredLanguage } from "../utils/language";

  async function updateLanguage() {
    const lang = await readStoredLanguage();
    const baseLang = document
      .querySelector('h1.hero-title[data-lang]:not([data-lang="eu"])')
      ?.getAttribute("data-lang");

    if (baseLang) {
      const elements = document.querySelectorAll("[data-lang]");
      elements.forEach((el) => {
        const elLang = el.getAttribute("data-lang");
        if (lang === "eu") {
          if (elLang === "eu") el.classList.remove("hidden");
          if (elLang === baseLang) el.classList.add("hidden");
        } else {
          if (elLang === "eu") el.classList.add("hidden");
          if (elLang === baseLang) el.classList.remove("hidden");
        }
      });
    }
  }

  updateLanguage();
  document.addEventListener("language-change", updateLanguage);
</script>
