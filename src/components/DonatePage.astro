---
import MainLayout from "../layouts/MainLayout.astro";
import type { DonateLocaleContent } from "../data/donate.i18n";
import { marked } from "marked";
import progressEn from "../data/progress.json";
import progressEs from "../data/progress-es.json";
import progressFr from "../data/progress-fr.json";

export interface Props {
  lang: 'en' | 'es' | 'fr';
  t: DonateLocaleContent; // now includes a single `card`
}

const { lang, t } = Astro.props as Props;

const progressByLang: Record<'en' | 'es' | 'fr', any> = {
  en: progressEn,
  es: progressEs,
  fr: progressFr,
};

const currencyFormatter: Record<'uk' | 'es' | 'fr', Intl.NumberFormat> = {
  uk: new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0 }),
  es: new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }),
  fr: new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }),
};

const progressData = progressByLang[lang];

const fundData = (() => {
  if (!progressData) return undefined;
  if (t.card.id === 'uk') return progressData.funds_gbp;
  if (t.card.id === 'es') return progressData.funds_eur;
  if (t.card.id === 'fr') return progressData.funds_eur_fr ?? progressData.funds_eur;
  return undefined;
})();

const urls: Record<'uk' | 'es' | 'fr', string | undefined> = {
  uk: import.meta.env.PUBLIC_DONATE_UK_URL as string | undefined,
  es: import.meta.env.PUBLIC_DONATE_ES_URL as string | undefined,
  fr: import.meta.env.PUBLIC_DONATE_FR_URL as string | undefined,
};
---
<MainLayout title={t.metaTitle}>
  <div
    transition:name="donate-card"
    class="m-4 md:m-8 lg:m-12 p-6 md:p-8 lg:p-10 bg-gray-900/70 rounded-xl max-w-6xl w-full mx-auto font-sans pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)]"
  >
    <div class="text-center">
      <h1 class="font-display font-extrabold text-5xl md:text-6xl lg:text-7xl text-white">
        {t.heroTitle}
      </h1>
      <div
        class="mt-4 max-w-3xl mx-auto text-left text-xl md:text-2xl text-white leading-relaxed [&>*:not(:first-child)]:mt-6 [&_p]:text-white [&_p]:text-left [&_ul]:text-left [&_ul]:list-disc [&_ul]:pl-6 [&_li]:ml-1"
        set:html={marked.parse(t.heroIntroMd)}
      ></div>
    </div>

    <div class="mt-12 max-w-3xl mx-auto">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center flex flex-col">
        <h2 class="font-display font-bold text-2xl md:text-3xl text-gray-900">{t.card.title}</h2>
        <div class="my-4 flex-grow flex justify-center items-center">
          <img src={t.card.image.src} alt={t.card.image.alt} class="h-12" />
        </div>
        {fundData && (
          <div class="mb-4 text-left bg-gray-50 border border-gray-100 rounded-lg p-4">
            <p class="text-sm font-semibold uppercase tracking-wide text-gray-500">
              {fundData.label}
            </p>
            <p class="text-2xl font-bold text-brand-blue mt-1">
              {currencyFormatter[t.card.id].format(fundData.current)}
            </p>
            {typeof fundData.total === 'number' && (
              <p class="text-sm text-gray-600 mt-2">
                {(fundData.targetLabel ?? 'Target')}: {currencyFormatter[t.card.id].format(fundData.total)}
              </p>
            )}
          </div>
        )}
        <div
          class="text-left text-gray-600 leading-relaxed flex-grow [&_p]:text-gray-600 [&_p]:text-left [&_ul]:list-disc [&_ul]:pl-5 [&_li]:ml-1"
          set:html={marked.parse(t.card.bodyMd)}
        ></div>
        {urls[t.card.id] ? (
          <a
            href={urls[t.card.id]!}
            target="_blank"
            rel="noopener noreferrer"
            class="mt-6 inline-block w-full px-8 py-3 text-white bg-brand-teal hover:bg-teal-600 font-bold text-lg rounded-full transition-transform transform hover:scale-105"
          >
            {t.card.buttonLabel}
          </a>
        ) : (
          <p class="mt-6 text-sm text-gray-300 italic">{t.comingSoon}</p>
        )}
      </div>
    </div>
  </div>
</MainLayout>
